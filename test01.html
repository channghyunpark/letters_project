<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interactive Keyboard — Single HTML</title>
  <style>
    :root{
      --bg1:#0f1021; --bg2:#1b1d3a; --fg:#e6e6f0; --accent:#7cf7ff; --accent2:#b388ff;
      --card:rgba(255,255,255,.08); --border:rgba(255,255,255,.2);
    }
    [data-theme="light"]{
      --bg1:#fafbff; --bg2:#eef1ff; --fg:#1c1e26; --accent:#007aff; --accent2:#ff2d55;
      --card:rgba(0,0,0,.06); --border:rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg); background: radial-gradient(1200px 1200px at 80% 20%, var(--bg2), var(--bg1));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Apple SD Gothic Neo", "Malgun Gothic", Helvetica, Arial, sans-serif;
      overflow:hidden;
    }
    .wrap{position:relative; width:100%; height:100%;}
    header{
      position:fixed; top:16px; left:16px; right:16px; display:flex; align-items:center; gap:12px; z-index:10;
    }
    .badge{padding:6px 10px; border:1px solid var(--border); background:var(--card); border-radius:999px; font-size:12px; letter-spacing:.02em}
    .spacer{flex:1}
    .btn{cursor:pointer; user-select:none}

    #stage{position:absolute; inset:0;}
    #dot{
      position:absolute; width:42px; height:42px; border-radius:12px; 
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 0 12px rgba(255,255,255,.25);
      left:calc(50% - 21px); top:calc(50% - 21px);
      display:grid; place-items:center; font-weight:700; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.4);
      transform:translate3d(0,0,0);
    }
    #key{
      position:absolute; left:50%; top:20%; transform:translate(-50%, -50%);
      font-size:10vw; line-height:1; font-weight:900; letter-spacing:.02em; opacity:.9;
      text-shadow:0 10px 40px rgba(0,0,0,.3);
      user-select:none; pointer-events:none;
    }
    #key small{display:block; font-size:16px; opacity:.7; text-align:center; letter-spacing:.08em; margin-top:10px}

    #log{
      position:fixed; left:16px; bottom:16px; right:16px; display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:var(--card); font-weight:600}

    #hint{
      position:fixed; right:16px; bottom:16px; padding:10px 14px; border-radius:12px; background:var(--card); border:1px solid var(--border); font-size:12px
    }

    /* particle */
    .p{position:absolute; width:10px; height:10px; border-radius:50%; pointer-events:none; mix-blend-mode:screen;}

    /* help overlay */
    #help{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.5); backdrop-filter: blur(6px);
    }
    #help .card{
      width:min(680px, calc(100% - 40px)); background:var(--bg1); color:var(--fg); border:1px solid var(--border); border-radius:16px; padding:20px 22px; box-shadow:0 20px 60px rgba(0,0,0,.35)
    }
    #help h2{margin:0 0 10px 0; font-size:20px}
    #help ul{margin:8px 0 0 18px; line-height:1.6}
    #help kbd{padding:3px 6px; border-radius:6px; border:1px solid var(--border); background:var(--card); font-weight:700; font-size:12px}
    .close{position:absolute; top:16px; right:16px; cursor:pointer; font-weight:800; opacity:.8}

    /* floating typed text */
    .bubble{
      position:absolute; padding:8px 12px; border-radius:999px; background:var(--card); border:1px solid var(--border);
      backdrop-filter: blur(4px);
      animation: rise 2.6s ease-out forwards;
      font-weight:700
    }
    @keyframes rise{ to{ transform: translateY(-120px); opacity:0 } }

  </style>
</head>
<body>
  <div class="wrap" id="app" data-theme="dark">
    <header>
      <div class="badge">Interactive Keyboard</div>
      <div class="badge">FPS: <span id="fps">—</span></div>
      <div class="spacer"></div>
      <div class="badge btn" id="toggleTheme" title="테마 전환 (Space)">Light/Dark</div>
      <div class="badge btn" id="openHelp" title="도움말 (H or ?)">Help</div>
    </header>

    <div id="stage">
      <div id="key">Press any key<small>키보드를 눌러보세요</small></div>
      <div id="dot" aria-live="polite">●</div>
    </div>

    <div id="log" aria-live="polite" aria-label="최근 입력 키"></div>
    <div id="hint">WASD/←↑→↓ 이동 · Space 테마 · H/? 도움말 · ESC 초기화</div>

    <div id="help">
      <div class="card">
        <div class="close" id="closeHelp">✕</div>
        <h2>도움말</h2>
        <ul>
          <li><kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> 또는 <kbd>←</kbd><kbd>↑</kbd><kbd>→</kbd><kbd>↓</kbd> : 중앙 블록 이동</li>
          <li><kbd>Space</kbd> : 라이트/다크 테마 전환</li>
          <li><kbd>숫자 1–5</kbd> : 파티클 색상 팔레트 변경</li>
          <li><kbd>H</kbd> 또는 <kbd>?</kbd> : 이 도움말 열기/닫기</li>
          <li><kbd>ESC</kbd> : 화면 초기화 (텍스트/파티클 제거, 위치 리셋)</li>
          <li>아무 글자나 입력: 입력한 글자가 떠오르는 말풍선으로 등장</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    const app = document.getElementById('app');
    const keyEl = document.getElementById('key');
    const logEl = document.getElementById('log');
    const stage = document.getElementById('stage');
    const dot = document.getElementById('dot');
    const fpsEl = document.getElementById('fps');
    const help = document.getElementById('help');
    const openHelp = document.getElementById('openHelp');
    const closeHelp = document.getElementById('closeHelp');
    const toggleThemeBtn = document.getElementById('toggleTheme');

    // ---- State ----
    let pos = { x: window.innerWidth/2 - 21, y: window.innerHeight/2 - 21 };
    let vel = { x: 0, y: 0 };
    const pressed = new Set();
    let lastKeys = [];
    let palette = 0;

    // ---- WebAudio (initialized lazily) ----
    let audioCtx = null;
    function initAudio(){
      if(audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    function playBeep(key){
      if(!audioCtx) return;
      const now = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      const base = key && key.length === 1 ? key.toUpperCase().charCodeAt(0) : 65;
      const freq = 220 + ((base % 24) * 12); // simple mapping
      o.frequency.setValueAtTime(freq, now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.2, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.00001, now + 0.20);
      o.connect(g).connect(audioCtx.destination);
      o.start(now);
      o.stop(now + 0.22);
    }

    // ---- Particles ----
    const palettes = [
      ['#7cf7ff','#b388ff','#ffffff'],
      ['#ffcc00','#ff6b6b','#ffd93d'],
      ['#00d1b2','#209cee','#92d36e'],
      ['#ff9ff3','#feca57','#48dbfb'],
      ['#c084fc','#22d3ee','#f472b6']
    ];
    function spawnParticles(x, y){
      const count = 16;
      for(let i=0;i<count;i++){
        const p = document.createElement('div');
        p.className = 'p';
        const c = palettes[palette][i % palettes[palette].length];
        p.style.background = c;
        stage.appendChild(p);
        const ang = (i / count) * Math.PI * 2 + Math.random()*0.4;
        const speed = 2 + Math.random()*4;
        let life = 500 + Math.random()*600;
        const vx = Math.cos(ang) * speed;
        const vy = Math.sin(ang) * speed;
        let px = x, py = y;
        const start = performance.now();
        const tick = (t)=>{
          const dt = t - start;
          if(dt > life){ p.remove(); return; }
          px += vx; py += vy + 0.08; // slight gravity
          p.style.transform = `translate(${px}px, ${py}px)`;
          p.style.opacity = String(1 - dt/life);
          requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
      }
    }

    function addLog(k){
      lastKeys.unshift(k);
      lastKeys = lastKeys.slice(0, 12);
      logEl.innerHTML = '';
      lastKeys.forEach(txt=>{
        const c = document.createElement('div');
        c.className = 'chip';
        c.textContent = txt;
        logEl.appendChild(c);
      });
    }

    function showKey(k){
      keyEl.innerHTML = `<span>${escapeHTML(k)}</span><small>${new Date().toLocaleTimeString()}</small>`;
      const rect = keyEl.getBoundingClientRect();
      spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2);
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"] /g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',' ':'&nbsp;'}[c]));
    }

    function toggleTheme(){
      const current = app.getAttribute('data-theme');
      app.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
    }

    // Typed text bubbles
    function bubble(char){
      if(!/^[\w\p{L}\p{N}\p{P}\p{S}]$/u.test(char)) return; // skip control-like
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = char;
      const x = pos.x + 21 + (Math.random()*60 - 30);
      const y = pos.y - 10 + (Math.random()*20 - 10);
      b.style.left = x + 'px'; b.style.top = y + 'px';
      stage.appendChild(b);
      setTimeout(()=>b.remove(), 2600);
    }

    // Movement control
    function updateVelocity(){
      const speed = pressed.has('Shift') ? 6 : 3.4;
      vel.x = (pressed.has('ArrowRight') || pressed.has('d')) * speed - (pressed.has('ArrowLeft') || pressed.has('a')) * speed;
      vel.y = (pressed.has('ArrowDown') || pressed.has('s')) * speed - (pressed.has('ArrowUp') || pressed.has('w')) * speed;
    }

    function clamp(v, min, max){ return Math.min(max, Math.max(min, v)); }

    // Animation loop
    let last = performance.now();
    let fpsAvg = 60;
    function loop(now){
      const dt = (now - last) / 16.6667; // ~frames
      last = now;
      // fps calc
      const fps = 1000 / (now - (loop.prev || now));
      loop.prev = now;
      fpsAvg = fpsAvg * 0.9 + fps * 0.1;
      fpsEl.textContent = Math.round(fpsAvg);

      pos.x = clamp(pos.x + vel.x * dt, 0, window.innerWidth - 42);
      pos.y = clamp(pos.y + vel.y * dt, 0, window.innerHeight - 42);
      dot.style.transform = `translate3d(${pos.x}px, ${pos.y}px, 0)`;
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // Events
    window.addEventListener('resize', ()=>{
      pos.x = clamp(pos.x, 0, window.innerWidth - 42);
      pos.y = clamp(pos.y, 0, window.innerHeight - 42);
    });

    document.addEventListener('keydown', (e)=>{
      if(!audioCtx) initAudio();
      // avoid repeating when key is held down
      if(e.repeat) return;

      const k = e.key;
      pressed.add(k.length === 1 ? k.toLowerCase() : k);
      updateVelocity();

      if(k === ' '){ e.preventDefault(); toggleTheme(); }
      else if(k === 'h' || k === 'H' || k === '?'){ help.style.display = help.style.display === 'grid' ? 'none' : 'grid'; }
      else if(k === 'Escape'){ resetAll(); }
      else if(/^[1-5]$/.test(k)){ palette = Number(k)-1; flashHint(`팔레트 ${k}`); }
      else { bubble(k); }

      showKey(labelForKey(k));
      addLog(labelForKey(k));
      playBeep(k);
    });

    document.addEventListener('keyup', (e)=>{
      pressed.delete(e.key.length === 1 ? e.key.toLowerCase() : e.key);
      updateVelocity();
    });

    toggleThemeBtn.addEventListener('click', toggleTheme);
    openHelp.addEventListener('click', ()=> help.style.display = 'grid');
    closeHelp.addEventListener('click', ()=> help.style.display = 'none');

    function labelForKey(k){
      if(k === ' ') return 'Space';
      if(k === 'ArrowUp' || k === 'ArrowDown' || k === 'ArrowLeft' || k === 'ArrowRight') return k.replace('Arrow','');
      if(k === 'Escape') return 'ESC';
      return k;
    }

    function resetAll(){
      // remove particles & bubbles
      [...stage.querySelectorAll('.p,.bubble')].forEach(n=>n.remove());
      // reset pos
      pos = { x: window.innerWidth/2 - 21, y: window.innerHeight/2 - 21 };
      dot.style.transform = `translate3d(${pos.x}px, ${pos.y}px, 0)`;
      lastKeys = []; logEl.innerHTML='';
      showKey('Reset');
    }

    function flashHint(text){
      const h = document.getElementById('hint');
      const old = h.textContent;
      h.textContent = text + ' · ' + old;
      setTimeout(()=>{ h.textContent = old; }, 1200);
    }

    // Nice first appearance
    setTimeout(()=> showKey('Press any key'), 200);
  </script>
</body>
</html>
